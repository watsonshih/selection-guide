const rulesDatabase = {
    "109": {
        otherRequirements: "英語能力認證",
        creditTable: [
            { category: "語文素養", credits: "8", description: "中文 6 學分 + 英文 6 學分，其中 8 學分計必修，其餘 4 學分不計入最低畢業學分" },
            { category: "跨院選修", credits: "6", description: "可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1–2", description: "服務學習 1 學分<br>非軍訓應用性課程可計 1 學分為最低畢業學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    },
    "110": {
        otherRequirements: "英語能力認證、全英語專班須修 6 學分英文博雅",
        creditTable: [
            { category: "語文素養", credits: "8", description: "中文 6 學分 + 英文 6 學分，其中 8 學分計必修，其餘 4 學分不計入最低畢業學分" },
            { category: "跨院選修", credits: "6", description: "可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1", description: "服務學習 1 學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    },
    "111": {
        otherRequirements: "英語能力認證、本土語言可抵跨院至多 2 學分",
        creditTable: [
            { category: "語文素養", credits: "6", description: "中文 3 學分 + 英文 3 學分" },
            { category: "跨院選修", credits: "8", description: "含 1 門 EAP/ESP，可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1", description: "服務學習 1 學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    },
    "112": {
        otherRequirements: "英語能力認證、醫學院學生納入第五、六向度限制",
        creditTable: [
            { category: "語文素養", credits: "6", description: "中文 3 學分 + 英文 3 學分" },
            { category: "跨院選修", credits: "8", description: "含 1 門 EAP/ESP，可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海、醫學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1", description: "服務學習 1 學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    },
    "113": {
        otherRequirements: "英語能力認證、外文系可用兩門專業選修抵英文必修 + EAP/ESP",
        creditTable: [
            { category: "語文素養", credits: "6", description: "中文 3 學分 + 英文 3 學分" },
            { category: "跨院選修", credits: "8", description: "含 1 門 EAP/ESP，可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海、醫學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1", description: "服務學習 1 學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    },
    "114": {
        otherRequirements: "英語能力認證、外文系可用兩門專業選修抵英文必修 + EAP/ESP",
        creditTable: [
            { category: "語文素養", credits: "6", description: "中文 3 學分 + 英文 3 學分" },
            { category: "跨院選修", credits: "8", description: "含 1 門 EAP/ESP，可選擇學院不同領域課程" },
            { category: "博雅課程", credits: "13", description: "需涵蓋至少 4 個向度課程<br>理、工、海、醫學生第五向度及第六向度最低畢業學分至多只採計 6 學分<br>文、管、社學生第五向度及第六向度的課程至少需各修習 2 學分<br>西灣學院學生自由選修" },
            { category: "體驗性課程", credits: "1", description: "服務學習 1 學分<br>大學之道 6 場次" },
            { category: "運動與健康", credits: "4", description: "不列最低畢業學分，但計入修習總學分" }
        ]
    }
};

// 英語修課流程資料庫
const englishCourseFlowDatabase = {
    "112-114": {
        "初級": "英文初級 (0 學分) → 英文中級 → 中高級 EAP/ESP",
        "中級": "英文中級 → 中高級 EAP/ESP",
        "中高級": "英文中高級 → 高級 EAP/ESP",
        "高級": "高級 EAP/ESP（免修英文中高級，視為抵免通過，計 3 學分）"
    },
    "111": {
        "初級": "英文初級 (0 學分) → 通識英文與 EAP/ESP 可交錯搭配，累計達中高級即可",
        "中級": "通識英文與 EAP/ESP 可交錯搭配，累計達中高級即可",
        "中高級": "通識英文與 EAP/ESP 可交錯搭配，累計達高級即可",
        "高級": "高級 EAP/ESP（免修英文中高級，視為抵免通過，計 3 學分）"
    },
    "110": {
        "初級": "英文初級 (0 學分) → 英文中級 → 英文中高級",
        "中級": "英文中級 → 英文中高級",
        "中高級": "英文中高級 → 英文高級",
        "高級": "英文高級 (免修英文中高級，視為抵免通過，計 2 學分)"
    },
    "109": {
        "初級": "英文初級 (0 學分) → 英文中級 → 英文中高級",
        "中級": "英文中級 → 英文中高級",
        "中高級": "英文中高級 → 英文高級",
        "高級": "英文高級 (免修英文中高級，視為抵免通過，計 2 學分)"
    }
};

// 英語檢定門檻資料庫
const englishCertificationDatabase = {
    "111-114": {
        general: [
            { test: "TOEIC", standard: "聽力＋閱讀 600 分" },
            { test: "IELTS", standard: "5 級" },
            { test: "TOEFL-iBT", standard: "61 分" },
            { test: "TOEFL-ITP", standard: "500 分" },
            { test: "GEPT", standard: "中高級初試" },
            { test: "TOEIC Speaking / Writing", standard: "任一測驗 130 分" },
            { test: "BESTEP", standard: "聽讀 或 口寫 B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "閱讀 300 分" },
            { test: "IELTS", standard: "閱讀 5 級、寫作 5 級" },
            { test: "TOEFL-iBT", standard: "閱讀 15 分" },
            { test: "TOEFL-ITP", standard: "文法結構(Part 2)＋閱讀(Part 3) 平均 50 分" },
            { test: "GEPT", standard: "中高級初試閱讀 80 分" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "BESTEP", standard: "閱讀 B1+" }
        ]
    },
    "110": {
        general: [
            { test: "TOEIC", standard: "聽力＋閱讀 600 分" },
            { test: "IELTS", standard: "5 級" },
            { test: "TOEFL-iBT", standard: "61 分" },
            { test: "TOEFL-ITP", standard: "500 分" },
            { test: "GEPT", standard: "中高級初試" },
            { test: "TOEIC Speaking / Writing", standard: "任一測驗 130 分" },
            { test: "校內英語測驗", standard: "CEFR B1+" },
            { test: "BESTEP", standard: "聽讀 或 口寫 B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "閱讀 300 分" },
            { test: "IELTS", standard: "閱讀 5 級、寫作 5 級" },
            { test: "TOEFL-iBT", standard: "閱讀 15 分" },
            { test: "TOEFL-ITP", standard: "文法結構(Part 2)＋閱讀(Part 3) 平均 50 分" },
            { test: "GEPT", standard: "中高級初試閱讀 80 分" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "校內英語測驗", standard: "閱讀成績 B1+" },
            { test: "BESTEP", standard: "閱讀 B1+" }
        ]
    },
    "109": {
        general: [
            { test: "TOEIC", standard: "聽力＋閱讀 600 分" },
            { test: "IELTS", standard: "5 級" },
            { test: "TOEFL-iBT", standard: "61 分" },
            { test: "TOEFL-ITP", standard: "500 分" },
            { test: "GEPT", standard: "中高級初試" },
            { test: "TOEIC Speaking / Writing", standard: "任一測驗 130 分" },
            { test: "校內英語測驗", standard: "CEFR B1+" },
            { test: "BESTEP", standard: "聽讀 或 口寫 B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "閱讀 300 分" },
            { test: "IELTS", standard: "閱讀 5 級、寫作 5 級" },
            { test: "TOEFL-iBT", standard: "閱讀 15 分" },
            { test: "TOEFL-ITP", standard: "文法結構(Part 2)＋閱讀(Part 3) 平均 50 分" },
            { test: "GEPT", standard: "中高級初試閱讀 80 分" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "校內英語測驗", standard: "閱讀成績 B1+" },
            { test: "BESTEP", standard: "閱讀 B1+" }
        ]
    }
};

// 英語實踐歷程資料庫
const englishPracticePortfolioDatabase = {
    "110-114": [
        "English Table",
        "English Corner",
        "英文寫作工坊 (English Writing Lab)",
        "EMI 相關活動"
    ],
    "109": [
        "English Table",
        "English Corner",
        "英語自學園 (L 棟 English Plaza)",
        "英語小老師諮詢",
        "EMI 相關活動"
    ]
};

// 英語檢定抵免標準資料庫
const englishExemptionDatabase = {
    "113-114": {
        exemptionScope: "僅可抵免一門英語文課程學分",
        standards: [
            { test: "GEPT", standard: "中高級複試通過" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (聽讀＋口說寫作)" }
        ]
    },
    "112": {
        exemptionScope: "僅可抵免一門英語文課程學分",
        standards: [
            { test: "GEPT", standard: "中高級複試通過" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (聽讀＋口說寫作)" }
        ]
    },
    "111": {
        exemptionScope: "通識英文 + 跨院 EAP/ESP 均可抵免",
        standards: [
            { test: "GEPT", standard: "中高級複試通過" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (聽讀＋口說寫作)" }
        ]
    },
    "110": {
        exemptionScope: "通識英文 + 跨院 EAP/ESP 均可抵免",
        standards: [
            { test: "GEPT", standard: "中高級複試通過" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (聽讀＋口說寫作)" }
        ]
    },
    "109": {
        exemptionScope: "通識英文 + 跨院 EAP/ESP 均可抵免",
        standards: [
            { test: "GEPT", standard: "中高級複試通過" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "750" },
            { test: "TOEIC S&W", standard: "300" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (聽讀＋口說寫作)" }
        ]
    }
};

// 選課階段規定
const selectionStageRules = {
    // 大一的選課規定
    "1": {
        "stages": [
            { name: "初選一", language: true, crossCollege: true, general: true, service: false, applied: false, sportRequired: true, sportElective: false },
            { name: "初選二", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "加退選一", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "加退選二", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "異常處理", language: "限特定情況", crossCollege: "限特定情況", general: "限特定情況", service: "限特定情況", applied: "限特定情況", sportRequired: "限特定情況", sportElective: "限特定情況" }
        ],
        "notes": [
            "語文課程、服務學習：當學期選上「一門」為限",
            "跨院選修及博雅課程：初選階段選上「一門」為限，在加退選階段則可以加選第二門",
            "初選二及加退選二階段可加選未選上類別之課程",
            "異常處理非正常選課階段，需符合特定事由及程序（課程異動、未選上必修、影響畢業等，服務學習、博雅、英語文課程異常處理需額外取得加簽貼紙）"
        ]
    },
    // 大二的選課規定
    "2": {
        "stages": [
            { name: "初選一", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: true, sportElective: false },
            { name: "初選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "加退選一", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "加退選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "異常處理", language: "限特定情況", crossCollege: "限特定情況", general: "限特定情況", service: "限特定情況", applied: "限特定情況", sportRequired: "限特定情況", sportElective: "限特定情況" }
        ],
        "notes": [
            "語文課程、服務學習：當學期選上「一門」為限",
            "跨院選修及博雅課程：初選階段選上「一門」為限，在加退選階段則可以加選第二門",
            "初選二及加退選二階段：可加選未選上類別之課程",
            "異常處理階段：本階段非正常選課階段，需符合特定事由及程序（課程異動、未選上必修、影響畢業等，服務學習、博雅、英語文課程異常處理需額外取得加簽貼紙）"
        ]
    },
    // 大三的選課規定
    "3": {
        "stages": [
            { name: "初選一", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: false, sportElective: true },
            { name: "初選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: false, sportElective: true },
            { name: "加退選一", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "加退選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "異常處理", language: "限特定情況", crossCollege: "限特定情況", general: "限特定情況", service: "限特定情況", applied: "限特定情況", sportRequired: "限特定情況", sportElective: "限特定情況" }
        ],
        "notes": [
            "語文課程、服務學習：當學期選上「一門」為限",
            "跨院選修及博雅課程：初選階段選上「一門」為限，在加退選階段則可以加選第二門",
            "初選二及加退選二階段：可加選未選上類別之課程",
            "異常處理階段：本階段非正常選課階段，需符合特定事由及程序（課程異動、未選上必修、影響畢業等，服務學習、博雅、英語文課程異常處理需額外取得加簽貼紙）"
        ]
    },
    // 大四的選課規定
    "4": {
        "stages": [
            { name: "初選一", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: false, sportElective: true },
            { name: "初選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: false, sportElective: true },
            { name: "加退選一", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "加退選二", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "異常處理", language: "限特定情況", crossCollege: "限特定情況", general: "限特定情況", service: "限特定情況", applied: "限特定情況", sportRequired: "限特定情況", sportElective: "限特定情況" }
        ],
        "notes": [
            "語文課程、服務學習：當學期選上「一門」為限",
            "跨院選修及博雅課程：初選階段選上「一門」為限，在加退選階段則可以加選第二門",
            "初選二及加退選二階段：可加選未選上類別之課程",
            "異常處理階段：本階段非正常選課階段，需符合特定事由及程序（課程異動、未選上必修、影響畢業等，服務學習、博雅、英語文課程異常處理需額外取得加簽貼紙）"
        ]
    },
    // 碩士班的選課規定
    "5": {
        "stages": [
            { name: "初選一", language: false, crossCollege: false, general: false, service: false, applied: false, sportRequired: false, sportElective: false },
            { name: "初選二", language: false, crossCollege: false, general: false, service: false, applied: false, sportRequired: false, sportElective: false },
            { name: "加退選一", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: true },
            { name: "加退選二", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: true },
            { name: "異常處理", language: "限特定情況", crossCollege: "限特定情況", general: "限特定情況", service: "限特定情況", applied: "限特定情況", sportRequired: "限特定情況", sportElective: "限特定情況" }
        ],
        "notes": [
            "初選階段：碩士班學生不可選修通識課程",
            "加退選階段：碩士班學生開始可加選通識課程",
            "異常處理階段：限特定情況才可申請選課"
        ]
    }
};

const iconMap = {
    language: "fa-comment-alt",
    crossCollege: "fa-exchange-alt",
    general: "fa-book",
    experiential: "fa-hands-helping",
    sportHealth: "fa-running",
    other: "fa-clipboard-list"
};

const gradeMap = {
    "1": "大一",
    "2": "大二",
    "3": "大三",
    "4": "大四",
    "5": "碩士班"
};

document.addEventListener('DOMContentLoaded', function () {
    const searchButton = document.getElementById('searchButton');
    const admissionYearSelect = document.getElementById('admissionYear');
    const gradeSelect = document.getElementById('grade');
    const initialEnglishLevelSelect = document.getElementById('initialEnglishLevel');
    const resultsSection = document.getElementById('resultsSection');
    const ruleCards = document.getElementById('ruleCards');
    const creditTable = document.getElementById('creditTable');
    const stageTable = document.getElementById('stageTable');
    const yearGradeBadge = document.getElementById('yearGradeBadge');

    // 初始化展開區塊功能
    initExpandableSections();
    initSubExpandableSections();

    searchButton.addEventListener('click', function () {
        const admissionYear = admissionYearSelect.value;
        const grade = gradeSelect.value;
        const initialEnglishLevel = initialEnglishLevelSelect.value;

        if (!admissionYear || !grade) {
            showToast('請先選擇入學年度和年級', 'error');
            return;
        }

        if (grade !== "5" && !initialEnglishLevel) {
            showToast('請選擇初始英語分級', 'error');
            return;
        }

        // 顯示結果區塊
        resultsSection.style.display = 'block';

        // 清空之前的結果
        if (ruleCards) ruleCards.innerHTML = '';
        if (creditTable) {
            const tbody = creditTable.querySelector('tbody');
            if (tbody) tbody.innerHTML = '';
        }
        if (stageTable) {
            const tbody = stageTable.querySelector('tbody');
            if (tbody) tbody.innerHTML = '';
        }

        // 設定標籤
        if (yearGradeBadge) {
            yearGradeBadge.textContent = `${admissionYear} 學年度 ${gradeMap[grade]}`;
        }

        // 顯示各種規定
        displayRuleCards(admissionYear, grade);
        displayCreditTable(admissionYear, grade);
        displayStageTable(grade);

        // 只有非碩士班才顯示英語規定
        if (grade !== "5") {
            displayEnglishRequirements(admissionYear, initialEnglishLevel);
        }

        // 根據年級控制區塊顯示
        toggleSectionsByGrade(grade);

        // 滾動到結果區塊
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // 根據年級控制區塊顯示與隱藏
    function toggleSectionsByGrade(grade) {
        const isMaster = grade === "5"; // 碩士班

        const rulesSummary = document.querySelector('.rules-summary');
        const creditTableHeader = document.querySelector('[data-target="creditTableSection"]');
        const creditTableSection = document.getElementById('creditTableSection');
        const englishRequirementsHeader = document.querySelector('[data-target="englishRequirementsSection"]');
        const englishRequirementsSection = document.getElementById('englishRequirementsSection');
        const stageTableHeader = document.querySelector('[data-target="stageTableSection"]');
        const recommendationsHeader = document.querySelector('[data-target="recommendationsSection"]');
        const recommendationsSection = document.getElementById('recommendationsSection');

        if (isMaster) {
            // 碩士班只顯示選課階段規定
            expandAllSections();
            if (rulesSummary) rulesSummary.style.display = 'none';
            if (creditTableHeader) creditTableHeader.style.display = 'none';
            if (creditTableSection) creditTableSection.style.display = 'none';
            if (englishRequirementsHeader) englishRequirementsHeader.style.display = 'none';
            if (englishRequirementsSection) englishRequirementsSection.style.display = 'none';
            if (stageTableHeader) stageTableHeader.style.display = 'flex';
            if (recommendationsHeader) recommendationsHeader.style.display = 'none';
            if (recommendationsSection) recommendationsSection.style.display = 'none';
        } else {
            // 其他年級全部顯示
            if (rulesSummary) rulesSummary.style.display = 'block';
            if (creditTableHeader) creditTableHeader.style.display = 'flex';
            if (creditTableSection) creditTableSection.style.display = '';
            if (englishRequirementsHeader) englishRequirementsHeader.style.display = 'flex';
            if (englishRequirementsSection) englishRequirementsSection.style.display = '';
            if (stageTableHeader) stageTableHeader.style.display = 'flex';
            if (recommendationsHeader) recommendationsHeader.style.display = 'flex';
            if (recommendationsSection) recommendationsSection.style.display = '';
        }
    }

    function displayRuleCards(year, grade) {
        if (grade === "5" || !ruleCards) return; // 碩士班不需要顯示規則卡片

        const rules = rulesDatabase[year];
        if (!rules) return;

        const cardsData = [
            { title: '語文素養', icon: iconMap.language, credit: rules.creditTable[0].credits },
            { title: '跨院選修', icon: iconMap.crossCollege, credit: rules.creditTable[1].credits },
            { title: '博雅課程', icon: iconMap.general, credit: rules.creditTable[2].credits },
            { title: '體驗性課程', icon: iconMap.experiential, credit: rules.creditTable[3].credits },
            { title: '運動與健康', icon: iconMap.sportHealth, credit: rules.creditTable[4].credits },
            { title: '其他規定', icon: iconMap.other, content: rules.otherRequirements }
        ];

        cardsData.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'rule-card';
            if (card.title === '其他規定') {
                cardElement.innerHTML = `
                    <h4>${card.title}</h4>
                    <p>${card.content}</p>
                `;
            } else {
                cardElement.innerHTML = `
                    <h4>${card.title}</h4>
                    <p class="credit-num">${card.credit}</p>
                    <p>學分</p>      
                `;
            }
            ruleCards.appendChild(cardElement);
        });
    }

    function displayCreditTable(year, grade) {
        // 碩士班不需要顯示學分表
        if (grade === "5" || !creditTable) return;

        const tbody = creditTable.querySelector('tbody');
        if (!tbody) return;

        const rules = rulesDatabase[year];
        if (!rules) return;

        rules.creditTable.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.category}</td>
                <td>${item.credits}</td>
                <td>${item.description}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayStageTable(grade) {
        if (!stageTable) return;

        const tbody = stageTable.querySelector('tbody');
        if (!tbody) return;

        const gradeRules = selectionStageRules[grade];
        if (!gradeRules) return;

        gradeRules.stages.forEach(stage => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${stage.name}</td>
                <td>${renderStatus(stage.language)}</td>
                <td>${renderStatus(stage.crossCollege)}</td>
                <td>${renderStatus(stage.general)}</td>
                <td>${renderStatus(stage.service)}</td>
                <td>${renderStatus(stage.applied)}</td>
                <td>${renderStatus(stage.sportRequired)}</td>
                <td>${renderStatus(stage.sportElective)}</td>
            `;
            tbody.appendChild(row);
        });

        const stageNote = document.getElementById('stageNote');
        if (stageNote) {
            const notesHtml = gradeRules.notes.map(note => `<li>${note}</li>`).join('');
            stageNote.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>備註</strong>
                    <ul>${notesHtml}</ul>
                </div>`;
        }
    }

    function displayEnglishRequirements(admissionYear, initialEnglishLevel) {
        // 顯示修課流程
        displayEnglishCourseFlow(admissionYear, initialEnglishLevel);

        // 顯示檢定門檻
        displayEnglishCertificationTest(admissionYear);

        // 顯示實踐歷程
        displayEnglishPracticePortfolio(admissionYear);

        // 顯示抵免標準
        displayEnglishExemption(admissionYear);
    }

    function displayEnglishCourseFlow(admissionYear, initialEnglishLevel) {
        const flowDisplay = document.getElementById('englishCourseFlowDisplay');
        if (!flowDisplay) return;

        let yearGroup = "";
        if (["112", "113", "114"].includes(admissionYear)) {
            yearGroup = "112-114";
        } else if (admissionYear === "111") {
            yearGroup = "111";
        } else if (admissionYear === "110") {
            yearGroup = "110";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const flowData = englishCourseFlowDatabase[yearGroup];
        if (!flowData) return;

        const flowText = flowData[initialEnglishLevel];
        if (!flowText) return;

        flowDisplay.className = 'course-flow-display';
        flowDisplay.innerHTML = `
                <div class="flow-path">${flowText}</div>
        `;
    }

    function displayEnglishCertificationTest(admissionYear) {
        const testTable = document.getElementById('englishCertTestTable');
        if (!testTable) return;

        const tbody = testTable.querySelector('tbody');
        if (!tbody) return;

        tbody.innerHTML = '';

        const testTableHead = testTable.querySelector('thead');
        if (testTableHead) {
            testTableHead.innerHTML = `
                <tr>
                    <th>測驗 / 指標</th>
                    <th>一般生標準</th>
                    <th>聽障生標準</th>
                </tr>
            `;
        }

        let yearGroup = "";
        if (["111", "112", "113", "114"].includes(admissionYear)) {
            yearGroup = "111-114";
        } else if (admissionYear === "110") {
            yearGroup = "110";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const certificationData = englishCertificationDatabase[yearGroup];
        if (!certificationData) return;

        // 合併一般生和聽障生資料，根據測驗名稱配對
        const generalTests = certificationData.general;
        const hearingImpairedTests = certificationData.hearingImpaired;

        generalTests.forEach(generalItem => {
            const hearingImpairedItem = hearingImpairedTests.find(item => item.test === generalItem.test);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${generalItem.test}</td>
                <td>${generalItem.standard}</td>
                <td>${hearingImpairedItem ? hearingImpairedItem.standard : '-'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayEnglishPracticePortfolio(admissionYear) {
        const portfolioDisplay = document.getElementById('englishPracticePortfolioDisplay');
        if (!portfolioDisplay) return;

        let yearGroup = "";
        if (["110", "111", "112", "113", "114"].includes(admissionYear)) {
            yearGroup = "110-114";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const portfolioData = englishPracticePortfolioDatabase[yearGroup];
        if (!portfolioData) return;

        const itemsHtml = portfolioData.map(item => `<li>${item}</li>`).join('');

        portfolioDisplay.innerHTML = `
            <p>您需要累積 <strong>100 點</strong>，認點項目包括：</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                ${itemsHtml}
            </ul>
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                詳細點數計算方式請參考全英語卓越教學中心公告。
            </p>
        `;
    }

    function displayEnglishExemption(admissionYear) {
        const exemptionDisplay = document.getElementById('englishExemptionDisplay');
        if (!exemptionDisplay) return;

        let yearGroup = admissionYear;
        if (["113", "114"].includes(admissionYear)) {
            yearGroup = "113-114";
        }

        const exemptionData = englishExemptionDatabase[yearGroup];
        if (!exemptionData) return;

        const standardsHtml = exemptionData.standards.map(item =>
            `<tr><td>${item.test}</td><td>${item.standard}</td></tr>`
        ).join('');

        exemptionDisplay.innerHTML = `
            <div class="note">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>您適用的抵免範圍：</strong>${exemptionData.exemptionScope}
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>測驗 / 指標</th>
                            <th>門檻</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${standardsHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderStatus(status) {
        if (status === true) {
            return '<span class="check-icon"><i class="far fa-check-circle"></i></span>';
        } else if (status === false) {
            return '<span class="cross-icon"><i class="far fa-times-circle"></i></span>';
        } else {
            return `<span class="special-note">${status}</span>`;
        }
    }

    function initExpandableSections() {
        const headers = document.querySelectorAll('.section-header');

        headers.forEach(header => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'none';

                header.addEventListener('click', function () {
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        content.classList.add('active');
                        header.classList.add('active');
                    } else {
                        content.style.display = 'none';
                        content.classList.remove('active');
                        header.classList.remove('active');
                    }
                });
            }
        });
    }

    function initSubExpandableSections() {
        const subHeaders = document.querySelectorAll('.sub-section-header');

        subHeaders.forEach(header => {
            const targetId = header.getAttribute('data-sub-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'none';

                header.addEventListener('click', function () {
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        content.classList.add('active');
                        header.classList.add('active');
                    } else {
                        content.style.display = 'none';
                        content.classList.remove('active');
                        header.classList.remove('active');
                    }
                });
            }
        });
    }

    function expandAllSections() {
        const headers = document.querySelectorAll('.section-header');

        headers.forEach(header => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'block';
                content.classList.add('active');
                header.classList.add('active');
            }
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
});