const rulesDatabase = {
    "109": {
        otherRequirements: "English Proficiency Certification",
        creditTable: [
            { category: "Language Literacy", credits: "8", description: "Chinese 6 credits + English 6 credits. Among these, 8 credits are counted as required, while the remaining 4 are not counted towards the minimum graduation credits." },
            { category: "Inter-college Electives", credits: "6", description: "Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, and Marine Sciences can count a maximum of 6 credits from the 5th and 6th dimensions. <br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose." },
            { category: "Practical Experience Courses", credits: "1–2", description: "Service Learning: 1 credit. <br>1 credit from non-military training applied courses can be counted towards the minimum graduation credits. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    },
    "110": {
        otherRequirements: "English Proficiency Certification, students in all-English programs must take 6 credits of English-taught Liberal Arts courses.",
        creditTable: [
            { category: "Language Literacy", credits: "8", description: "Chinese 6 credits + English 6 credits. Among these, 8 credits are counted as required, while the remaining 4 are not counted towards the minimum graduation credits." },
            { category: "Inter-college Electives", credits: "6", description: "Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, and Marine Sciences can count a maximum of 6 credits from the 5th and 6th dimensions. <br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose.<br>Students in all-English programs must take at least 6 credits of English-taught Liberal Arts courses." },
            { category: "Practical Experience Courses", credits: "1", description: "Service Learning: 1 credit. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    },
    "111": {
        otherRequirements: "English Proficiency Certification, native language courses can count for up to 2 inter-college elective credits.",
        creditTable: [
            { category: "Language Literacy", credits: "6", description: "Chinese 3 credits + English 3 credits. " },
            { category: "Inter-college Electives", credits: "8", description: "Includes 1 EAP/ESP course.  Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, and Marine Sciences can count a maximum of 6 credits from the 5th and 6th dimensions. <br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose.<br>Students in all-English programs must take at least 6 credits of English-taught Liberal Arts courses." },
            { category: "Practical Experience Courses", credits: "1", description: "Service Learning: 1 credit. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    },
    "112": {
        otherRequirements: "English Proficiency Certification, Medical students are subject to the 5th and 6th dimension restrictions.",
        creditTable: [
            { category: "Language Literacy", credits: "6", description: "Chinese 3 credits + English 3 credits. " },
            { category: "Inter-college Electives", credits: "8", description: "Includes 1 EAP/ESP course.  Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, Marine Sciences, and Medicine can count a maximum of 6 credits from the 5th and 6th dimensions.<br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose.<br>Students in all-English programs must take at least 6 credits of English-taught Liberal Arts courses." },
            { category: "Practical Experience Courses", credits: "1", description: "Service Learning: 1 credit. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    },
    "113": {
        otherRequirements: "English Proficiency Certification, Foreign Languages Dept. students can use two major electives to waive required English + EAP/ESP courses.",
        creditTable: [
            { category: "Language Literacy", credits: "6", description: "Chinese 3 credits + English 3 credits." },
            { category: "Inter-college Electives", credits: "8", description: "Includes 1 EAP/ESP course. Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, Marine Sciences, and Medicine can count a maximum of 6 credits from the 5th and 6th dimensions.<br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose.<br>Students in all-English programs must take at least 6 credits of English-taught Liberal Arts courses." },
            { category: "Practical Experience Courses", credits: "1", description: "Service Learning: 1 credit. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    },
    "114": {
        otherRequirements: "English Proficiency Certification, Foreign Languages Dept. students can use two major electives to waive required English + EAP/ESP courses.",
        creditTable: [
            { category: "Language Literacy", credits: "6", description: "Chinese 3 credits + English 3 credits." },
            { category: "Inter-college Electives", credits: "8", description: "Includes 1 EAP/ESP course. Courses from different colleges can be selected." },
            { category: "Liberal Arts Courses", credits: "13", description: "Must cover courses from at least 4 dimensions.<br>Students from the Colleges of Science, Engineering, Marine Sciences, and Medicine can count a maximum of 6 credits from the 5th and 6th dimensions.<br>Students from the Colleges of Liberal Arts, Management, and Social Sciences must take at least 2 credits from the 5th and 6th dimensions each.<br>Students of Si-Wan College are free to choose.<br>Students in all-English programs must take at least 6 credits of English-taught Liberal Arts courses." },
            { category: "Practical Experience Courses", credits: "1", description: "Service Learning: 1 credit. <br>Primer on College Life: 6 lectures. " },
            { category: "Sport & Health", credits: "4", description: "Fall Semester, Freshman Year: Sport & Health: Physical Fitness. <br>Spring Semester, Freshman Year: Sport & Health: Basic Swimming. <br>\"Other Required Sport & Health Courses\": 2 credits.<br>Not counted towards the department's minimum graduation credits, but included in the total credits earned. " }
        ]
    }
};

// English Course Flow Database
const englishCourseFlowDatabase = {
    "112-114": {
        "Basic": "Basic General English (0 credits) → Intermediate General English → High-Intermediate EAP/ESP",
        "Intermediate": "Intermediate General English → High-Intermediate EAP/ESP",
        "High-Intermediate": "High-Intermediate General English → Advanced EAP/ESP",
        "Advanced": "Advanced EAP/ESP (Exempted from High-Intermediate General English, credited with 3 credits)"
    },
    "111": {
        "Basic": "Basic General English (0 credits) → Mix and match General English & EAP/ESP to reach High-Intermediate level",
        "Intermediate": "Mix and match General English & EAP/ESP to reach High-Intermediate level",
        "High-Intermediate": "Mix and match General English & EAP/ESP to reach Advanced level",
        "Advanced": "Advanced EAP/ESP (Exempted from High-Intermediate General English, credited with 3 credits)"
    },
    "110": {
        "Basic": "Basic English (0 credits) → Intermediate English → High-Intermediate English",
        "Intermediate": "Intermediate English → High-Intermediate English",
        "High-Intermediate": "High-Intermediate English → Advanced English",
        "Advanced": "Advanced English (Exempted from High-Intermediate English, credited with 2 credits)"
    },
    "109": {
        "Basic": "Basic English (0 credits) → Intermediate English → High-Intermediate English",
        "Intermediate": "Intermediate English → High-Intermediate English",
        "High-Intermediate": "High-Intermediate English → Advanced English",
        "Advanced": "Advanced English (Exempted from High-Intermediate English, credited with 2 credits)"
    }
};

// English Certification Database
const englishCertificationDatabase = {
    "111-114": {
        general: [
            { test: "TOEIC", standard: "Listening + Reading 600" },
            { test: "IELTS", standard: "5" },
            { test: "TOEFL-iBT", standard: "61" },
            { test: "TOEFL-ITP", standard: "500" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Test" },
            { test: "TOEIC Speaking / Writing", standard: "130 in either test" },
            { test: "BESTEP", standard: "Listening & Reading OR Speaking & Writing B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "Reading 300" },
            { test: "IELTS", standard: "Reading 5, Writing 5" },
            { test: "TOEFL-iBT", standard: "Reading 15" },
            { test: "TOEFL-ITP", standard: "Structure (Part 2) + Reading (Part 3) average 50" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Reading 80" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "BESTEP", standard: "Reading B1+" }
        ]
    },
    "110": {
        general: [
            { test: "TOEIC", standard: "Listening + Reading 600" },
            { test: "IELTS", standard: "5" },
            { test: "TOEFL-iBT", standard: "61" },
            { test: "TOEFL-ITP", standard: "500" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Test" },
            { test: "TOEIC Speaking / Writing", standard: "130 in either test" },
            { test: "Campus English Test", standard: "CEFR B1+" },
            { test: "BESTEP", standard: "Listening & Reading OR Speaking & Writing B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "Reading 300" },
            { test: "IELTS", standard: "Reading 5, Writing 5" },
            { test: "TOEFL-iBT", standard: "Reading 15" },
            { test: "TOEFL-ITP", standard: "Structure (Part 2) + Reading (Part 3) average 50" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Reading 80" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "Campus English Test", standard: "Reading Score B1+" },
            { test: "BESTEP", standard: "Reading B1+" }
        ]
    },
    "109": {
        general: [
            { test: "TOEIC", standard: "Listening + Reading 600" },
            { test: "IELTS", standard: "5" },
            { test: "TOEFL-iBT", standard: "61" },
            { test: "TOEFL-ITP", standard: "500" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Test" },
            { test: "TOEIC Speaking / Writing", standard: "130 in either test" },
            { test: "Campus English Test", standard: "CEFR B1+" },
            { test: "BESTEP", standard: "Listening & Reading OR Speaking & Writing B1+" }
        ],
        hearingImpaired: [
            { test: "TOEIC", standard: "Reading 300" },
            { test: "IELTS", standard: "Reading 5, Writing 5" },
            { test: "TOEFL-iBT", standard: "Reading 15" },
            { test: "TOEFL-ITP", standard: "Structure (Part 2) + Reading (Part 3) average 50" },
            { test: "GEPT", standard: "High-Intermediate Preliminary Reading 80" },
            { test: "TOEIC Speaking / Writing", standard: "-" },
            { test: "Campus English Test", standard: "Reading Score B1+" },
            { test: "BESTEP", standard: "Reading B1+" }
        ]
    }
};

// English Practice Portfolio Database
const englishPracticePortfolioDatabase = {
    "110-114": [
        "English Table",
        "English Corner",
        "English Writing Lab",
        "EMI-related Activities"
    ],
    "109": [
        "English Table",
        "English Corner",
        "English Plaza Self-Study (Building L)",
        "English Tutor Consultation",
        "EMI-related Activities"
    ]
};

// English Exemption Database
const englishExemptionDatabase = {
    "113-114": {
        exemptionScope: "Can only exempt one English language course. ",
        standards: [
            { test: "GEPT", standard: "High-Intermediate Final Test Passed" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (Listening & Reading + Speaking & Writing)" }
        ]
    },
    "112": {
        exemptionScope: "Can only exempt one English language course. ",
        standards: [
            { test: "GEPT", standard: "High-Intermediate Final Test Passed" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (Listening & Reading + Speaking & Writing)" }
        ]
    },
    "111": {
        exemptionScope: "Both General English + Inter-college EAP/ESP can be exempted.",
        standards: [
            { test: "GEPT", standard: "High-Intermediate Final Test Passed" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (Listening & Reading + Speaking & Writing)" }
        ]
    },
    "110": {
        exemptionScope: "Both General English + Inter-college EAP/ESP can be exempted.",
        standards: [
            { test: "GEPT", standard: "High-Intermediate Final Test Passed" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "785" },
            { test: "TOEIC S&W", standard: "310" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (Listening & Reading + Speaking & Writing)" }
        ]
    },
    "109": {
        exemptionScope: "Both General English + Inter-college EAP/ESP can be exempted.",
        standards: [
            { test: "GEPT", standard: "High-Intermediate Final Test Passed" },
            { test: "TOEFL iBT", standard: "71" },
            { test: "TOEFL ITP", standard: "527" },
            { test: "TOEIC L&R", standard: "750" },
            { test: "TOEIC S&W", standard: "300" },
            { test: "IELTS", standard: "5.5" },
            { test: "BESTEP", standard: "B2 (Listening & Reading + Speaking & Writing)" }
        ]
    }
};

// Course Selection Stage Rules
const selectionStageRules = {
    // Rules for Freshmen
    "1": {
        "stages": [
            { name: "Preliminary Selection 1", language: true, crossCollege: true, general: true, service: false, applied: false, sportRequired: true, sportElective: false },
            { name: "Preliminary Selection 2", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "Add/Drop 1", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "Add/Drop 2", language: true, crossCollege: true, general: true, service: false, applied: true, sportRequired: true, sportElective: false },
            { name: "Manual Processing", language: "Special cases only", crossCollege: "Special cases only", general: "Special cases only", service: "Special cases only", applied: "Special cases only", sportRequired: "Special cases only", sportElective: "Special cases only" }
        ],
        "notes": [
            "Language Courses, Service Learning: Limited to one course per semester.",
            "Inter-college Electives & Liberal Arts Courses: Limited to one course during the preliminary selection stage; a second course can be added during the add/drop stage. ",
            "During Preliminary Selection 2 and Add/Drop 2, you can add courses from categories you haven't registered for yet.",
            "Manual Processing is not a regular selection stage. It requires specific reasons and procedures (e.g., course changes, failure to register for a required course, graduation impact). Manual processing for Service Learning, Liberal Arts, and English courses requires an additional authorization slip."
        ]
    },
    // Rules for Sophomores
    "2": {
        "stages": [
            { name: "Preliminary Selection 1", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: true, sportElective: false },
            { name: "Preliminary Selection 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "Add/Drop 1", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "Add/Drop 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: false },
            { name: "Manual Processing", language: "Special cases only", crossCollege: "Special cases only", general: "Special cases only", service: "Special cases only", applied: "Special cases only", sportRequired: "Special cases only", sportElective: "Special cases only" }
        ],
        "notes": [
            "Language Courses, Service Learning: Limited to one course per semester.",
            "Inter-college Electives & Liberal Arts Courses: Limited to one course during the preliminary selection stage; a second course can be added during the add/drop stage. ",
            "During Preliminary Selection 2 and Add/Drop 2, you can add courses from categories you haven't registered for yet.",
            "Manual Processing is not a regular selection stage. It requires specific reasons and procedures (e.g., course changes, failure to register for a required course, graduation impact). Manual processing for Service Learning, Liberal Arts, and English courses requires an additional authorization slip."
        ]
    },
    // Rules for Juniors
    "3": {
        "stages": [
            { name: "Preliminary Selection 1", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: false, sportElective: true },
            { name: "Preliminary Selection 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: false, sportElective: true },
            { name: "Add/Drop 1", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "Add/Drop 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "Manual Processing", language: "Special cases only", crossCollege: "Special cases only", general: "Special cases only", service: "Special cases only", applied: "Special cases only", sportRequired: "Special cases only", sportElective: "Special cases only" }
        ],
        "notes": [
            "Language Courses, Service Learning: Limited to one course per semester.",
            "Inter-college Electives & Liberal Arts Courses: Limited to one course during the preliminary selection stage; a second course can be added during the add/drop stage. ",
            "During Preliminary Selection 2 and Add/Drop 2, you can add courses from categories you haven't registered for yet.",
            "Manual Processing is not a regular selection stage. It requires specific reasons and procedures (e.g., course changes, failure to register for a required course, graduation impact). Manual processing for Service Learning, Liberal Arts, and English courses requires an additional authorization slip."
        ]
    },
    // Rules for Seniors
    "4": {
        "stages": [
            { name: "Preliminary Selection 1", language: true, crossCollege: true, general: true, service: true, applied: false, sportRequired: false, sportElective: true },
            { name: "Preliminary Selection 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: false, sportElective: true },
            { name: "Add/Drop 1", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "Add/Drop 2", language: true, crossCollege: true, general: true, service: true, applied: true, sportRequired: true, sportElective: true },
            { name: "Manual Processing", language: "Special cases only", crossCollege: "Special cases only", general: "Special cases only", service: "Special cases only", applied: "Special cases only", sportRequired: "Special cases only", sportElective: "Special cases only" }
        ],
        "notes": [
            "Language Courses, Service Learning: Limited to one course per semester.",
            "Inter-college Electives & Liberal Arts Courses: Limited to one course during the preliminary selection stage; a second course can be added during the add/drop stage. ",
            "During Preliminary Selection 2 and Add/Drop 2, you can add courses from categories you haven't registered for yet.",
            "Manual Processing is not a regular selection stage. It requires specific reasons and procedures (e.g., course changes, failure to register for a required course, graduation impact). Manual processing for Service Learning, Liberal Arts, and English courses requires an additional authorization slip."
        ]
    },
    // Rules for Master's Students
    "5": {
        "stages": [
            { name: "Preliminary Selection 1", language: false, crossCollege: false, general: false, service: false, applied: false, sportRequired: false, sportElective: false },
            { name: "Preliminary Selection 2", language: false, crossCollege: false, general: false, service: false, applied: false, sportRequired: false, sportElective: false },
            { name: "Add/Drop 1", language: false, crossCollege: false, general: false, service: false, applied: true, sportRequired: true, sportElective: true },
            { name: "Add/Drop 2", language: false, crossCollege: false, general: false, service: false, applied: true, sportRequired: true, sportElective: true },
            { name: "Manual Processing", language: "Special cases only", crossCollege: "Special cases only", general: "Special cases only", service: "Special cases only", applied: "Special cases only", sportRequired: "Special cases only", sportElective: "Special cases only" }
        ],
        "notes": [
            "Preliminary Selection Stage: Master's students <b>cannot</b> register for any general education courses.",
            "Add/Drop Stage: Master's students can <b>only</b> register for Applied Courses and Sport & Health courses.",
            "Manual Processing Stage: Course registration is only possible under special circumstances."
        ]
    }
};

const iconMap = {
    language: "fa-comment-alt",
    crossCollege: "fa-exchange-alt",
    general: "fa-book",
    experiential: "fa-hands-helping",
    sportHealth: "fa-running",
    other: "fa-clipboard-list"
};

const gradeMap = {
    "1": "Freshman",
    "2": "Sophomore",
    "3": "Junior",
    "4": "Senior",
    "5": "Master's Program"
};

document.addEventListener('DOMContentLoaded', function () {
    const searchButton = document.getElementById('searchButton');
    const admissionYearSelect = document.getElementById('admissionYear');
    const gradeSelect = document.getElementById('grade');
    const initialEnglishLevelSelect = document.getElementById('initialEnglishLevel');
    const resultsSection = document.getElementById('resultsSection');
    const ruleCards = document.getElementById('ruleCards');
    const creditTable = document.getElementById('creditTable');
    const stageTable = document.getElementById('stageTable');
    const yearGradeBadge = document.getElementById('yearGradeBadge');

    // Initialize expandable sections
    initExpandableSections();
    initSubExpandableSections();
    initHelpTips();

    searchButton.addEventListener('click', function () {
        const admissionYear = admissionYearSelect.value;
        const grade = gradeSelect.value;
        const initialEnglishLevel = initialEnglishLevelSelect.value;

        if (!admissionYear || !grade) {
            showToast('Please select your admission year and grade first.', 'error');
            return;
        }

        if (grade !== "5" && !initialEnglishLevel) {
            showToast('Please select your initial English placement.', 'error');
            return;
        }

        // Show results section
        resultsSection.style.display = 'block';

        // Clear previous results
        if (ruleCards) ruleCards.innerHTML = '';
        if (creditTable) {
            const tbody = creditTable.querySelector('tbody');
            if (tbody) tbody.innerHTML = '';
        }
        if (stageTable) {
            const tbody = stageTable.querySelector('tbody');
            if (tbody) tbody.innerHTML = '';
        }

        // Set badge
        if (yearGradeBadge) {
            yearGradeBadge.textContent = `${admissionYear} AY ${gradeMap[grade]}`;
        }

        // Display various regulations
        displayRuleCards(admissionYear, grade);
        displayCreditTable(admissionYear, grade);
        displayStageTable(grade);

        // Display English requirements only for non-Master's students
        if (grade !== "5") {
            displayEnglishRequirements(admissionYear, initialEnglishLevel);
        }

        // Control section visibility based on grade
        toggleSectionsByGrade(grade);

        // Scroll to results section
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Toggle section visibility based on grade
    function toggleSectionsByGrade(grade) {
        const isMaster = grade === "5";

        const rulesSummary = document.querySelector('.rules-summary');
        const creditTableHeader = document.querySelector('[data-target="creditTableSection"]');
        const creditTableSection = document.getElementById('creditTableSection');
        const englishRequirementsHeader = document.querySelector('[data-target="englishRequirementsSection"]');
        const englishRequirementsSection = document.getElementById('englishRequirementsSection');
        const stageTableHeader = document.querySelector('[data-target="stageTableSection"]');
        const recommendationsHeader = document.querySelector('[data-target="recommendationsSection"]');
        const recommendationsSection = document.getElementById('recommendationsSection');

        if (isMaster) {
            // Master's students only see course selection stage rules
            expandAllSections();
            if (rulesSummary) rulesSummary.style.display = 'none';
            if (creditTableHeader) creditTableHeader.style.display = 'none';
            if (creditTableSection) creditTableSection.style.display = 'none';
            if (englishRequirementsHeader) englishRequirementsHeader.style.display = 'none';
            if (englishRequirementsSection) englishRequirementsSection.style.display = 'none';
            if (stageTableHeader) stageTableHeader.style.display = 'flex';
            if (recommendationsHeader) recommendationsHeader.style.display = 'none';
            if (recommendationsSection) recommendationsSection.style.display = 'none';
        } else {
            // Undergraduates see all sections
            if (rulesSummary) rulesSummary.style.display = 'block';
            if (creditTableHeader) creditTableHeader.style.display = 'flex';
            if (creditTableSection) creditTableSection.style.display = '';
            if (englishRequirementsHeader) englishRequirementsHeader.style.display = 'flex';
            if (englishRequirementsSection) englishRequirementsSection.style.display = '';
            if (stageTableHeader) stageTableHeader.style.display = 'flex';
            if (recommendationsHeader) recommendationsHeader.style.display = 'flex';
            if (recommendationsSection) recommendationsSection.style.display = '';
        }
    }

    function displayRuleCards(year, grade) {
        if (grade === "5" || !ruleCards) return; // No rule cards for Master's students

        const rules = rulesDatabase[year];
        if (!rules) return;

        const cardsData = [
            { title: 'Language Literacy', icon: iconMap.language, credit: rules.creditTable[0].credits },
            { title: 'Inter-college Electives', icon: iconMap.crossCollege, credit: rules.creditTable[1].credits },
            { title: 'Liberal Arts Courses', icon: iconMap.general, credit: rules.creditTable[2].credits },
            { title: 'Practical Experience Courses', icon: iconMap.experiential, credit: rules.creditTable[3].credits },
            { title: 'Sport & Health', icon: iconMap.sportHealth, credit: rules.creditTable[4].credits },
            { title: 'Other Regulations', icon: iconMap.other, content: rules.otherRequirements }
        ];

        cardsData.forEach(card => {
            const cardElement = document.createElement('div');
            cardElement.className = 'rule-card';
            if (card.title === 'Other Regulations') {
                cardElement.innerHTML = `
                    <h4>${card.title}</h4>
                    <p>${card.content}</p>
                `;
            } else {
                cardElement.innerHTML = `
                    <h4>${card.title}</h4>
                    <p class="credit-num">${card.credit}</p>
                    <p>Credits</p>      
                `;
            }
            ruleCards.appendChild(cardElement);
        });
    }

    function displayCreditTable(year, grade) {
        // No credit table for Master's students
        if (grade === "5" || !creditTable) return;

        const tbody = creditTable.querySelector('tbody');
        if (!tbody) return;

        const rules = rulesDatabase[year];
        if (!rules) return;

        rules.creditTable.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.category}</td>
                <td>${item.credits}</td>
                <td>${item.description}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayStageTable(grade) {
        if (!stageTable) return;

        const tbody = stageTable.querySelector('tbody');
        if (!tbody) return;

        const gradeRules = selectionStageRules[grade];
        if (!gradeRules) return;

        gradeRules.stages.forEach(stage => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${stage.name}</td>
                <td>${renderStatus(stage.language)}</td>
                <td>${renderStatus(stage.crossCollege)}</td>
                <td>${renderStatus(stage.general)}</td>
                <td>${renderStatus(stage.service)}</td>
                <td>${renderStatus(stage.applied)}</td>
                <td>${renderStatus(stage.sportRequired)}</td>
                <td>${renderStatus(stage.sportElective)}</td>
            `;
            tbody.appendChild(row);
        });

        const stageNote = document.getElementById('stageNote');
        if (stageNote) {
            const notesHtml = gradeRules.notes.map(note => `<li>${note}</li>`).join('');
            stageNote.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Notes</strong>
                    <ul>${notesHtml}</ul>
                </div>`;
        }
    }

    function displayEnglishRequirements(admissionYear, initialEnglishLevel) {
        // Display Course Flow
        displayEnglishCourseFlow(admissionYear, initialEnglishLevel);

        // Display Certification Test
        displayEnglishCertificationTest(admissionYear);

        // Display Practice Portfolio
        displayEnglishPracticePortfolio(admissionYear);

        // Display Exemption Standards
        displayEnglishExemption(admissionYear);
    }

    function displayEnglishCourseFlow(admissionYear, initialEnglishLevel) {
        const flowDisplay = document.getElementById('englishCourseFlowDisplay');
        if (!flowDisplay) return;

        let yearGroup = "";
        if (["112", "113", "114"].includes(admissionYear)) {
            yearGroup = "112-114";
        } else if (admissionYear === "111") {
            yearGroup = "111";
        } else if (admissionYear === "110") {
            yearGroup = "110";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const flowData = englishCourseFlowDatabase[yearGroup];
        if (!flowData) return;

        const levelMap = { "初級": "Basic", "中級": "Intermediate", "中高級": "High-Intermediate", "高級": "Advanced" };
        const englishLevel = levelMap[initialEnglishLevel];
        const flowText = flowData[englishLevel];
        if (!flowText) return;

        flowDisplay.className = 'course-flow-display';
        flowDisplay.innerHTML = `
                <div class="flow-path">${flowText}</div>
        `;
    }

    function displayEnglishCertificationTest(admissionYear) {
        const testTable = document.getElementById('englishCertTestTable');
        if (!testTable) return;

        const tbody = testTable.querySelector('tbody');
        if (!tbody) return;

        tbody.innerHTML = '';

        const testTableHead = testTable.querySelector('thead');
        if (testTableHead) {
            testTableHead.innerHTML = `
                <tr>
                    <th>Test / Indicator</th>
                    <th>Standard for General Students</th>
                    <th>Standard for Hearing-Impaired Students</th>
                </tr>
            `;
        }

        let yearGroup = "";
        if (["111", "112", "113", "114"].includes(admissionYear)) {
            yearGroup = "111-114";
        } else if (admissionYear === "110") {
            yearGroup = "110";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const certificationData = englishCertificationDatabase[yearGroup];
        if (!certificationData) return;

        // Combine general and hearing-impaired data based on test name
        const generalTests = certificationData.general;
        const hearingImpairedTests = certificationData.hearingImpaired;

        generalTests.forEach(generalItem => {
            const hearingImpairedItem = hearingImpairedTests.find(item => item.test === generalItem.test);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${generalItem.test}</td>
                <td>${generalItem.standard}</td>
                <td>${hearingImpairedItem ? hearingImpairedItem.standard : '-'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function displayEnglishPracticePortfolio(admissionYear) {
        const portfolioDisplay = document.getElementById('englishPracticePortfolioDisplay');
        if (!portfolioDisplay) return;

        let yearGroup = "";
        if (["110", "111", "112", "113", "114"].includes(admissionYear)) {
            yearGroup = "110-114";
        } else if (admissionYear === "109") {
            yearGroup = "109";
        }

        const portfolioData = englishPracticePortfolioDatabase[yearGroup];
        if (!portfolioData) return;

        const itemsHtml = portfolioData.map(item => `<li>${item}</li>`).join('');

        portfolioDisplay.innerHTML = `
            <p>You need to accumulate <strong>100 points</strong>. Recognized items include:</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                ${itemsHtml}
            </ul>
            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                For detailed point calculation, please refer to the announcements from the Center for EMI Teaching Excellence.
            </p>
        `;
    }

    function displayEnglishExemption(admissionYear) {
        const exemptionDisplay = document.getElementById('englishExemptionDisplay');
        if (!exemptionDisplay) return;

        let yearGroup = admissionYear;
        if (["113", "114"].includes(admissionYear)) {
            yearGroup = "113-114";
        }

        const exemptionData = englishExemptionDatabase[yearGroup];
        if (!exemptionData) return;

        const standardsHtml = exemptionData.standards.map(item =>
            `<tr><td>${item.test}</td><td>${item.standard}</td></tr>`
        ).join('');

        exemptionDisplay.innerHTML = `
            <div class="note">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Applicable Exemption Scope:</strong> ${exemptionData.exemptionScope}
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Test / Indicator</th>
                            <th>Threshold</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${standardsHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderStatus(status) {
        if (status === true) {
            return '<span class="check-icon"><i class="far fa-check-circle"></i></span>';
        } else if (status === false) {
            return '<span class="cross-icon"><i class="far fa-times-circle"></i></span>';
        } else {
            return `<span class="special-note">${status}</span>`;
        }
    }

    function initExpandableSections() {
        const headers = document.querySelectorAll('.section-header');

        headers.forEach(header => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'none';

                header.addEventListener('click', function () {
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        content.classList.add('active');
                        header.classList.add('active');
                    } else {
                        content.style.display = 'none';
                        content.classList.remove('active');
                        header.classList.remove('active');
                    }
                });
            }
        });
    }

    function initSubExpandableSections() {
        const subHeaders = document.querySelectorAll('.sub-section-header');

        subHeaders.forEach(header => {
            const targetId = header.getAttribute('data-sub-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'none';

                header.addEventListener('click', function () {
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        content.classList.add('active');
                        header.classList.add('active');
                    } else {
                        content.style.display = 'none';
                        content.classList.remove('active');
                        header.classList.remove('active');
                    }
                });
            }
        });
    }

    function initHelpTips() {
        const helpTips = document.querySelectorAll('.help-tip');

        helpTips.forEach(tip => {
            const tipType = tip.getAttribute('data-tip');
            const tooltip = document.getElementById(`tooltip-${tipType}`);

            if (tooltip) {
                let hideTimeout;

                tip.addEventListener('mouseenter', function () {
                    clearTimeout(hideTimeout);
                    positionTooltip(tip, tooltip);
                    tooltip.classList.add('show');
                });

                tip.addEventListener('mouseleave', function () {
                    hideTimeout = setTimeout(() => {
                        tooltip.classList.remove('show');
                    }, 200);
                });

                tip.addEventListener('click', function (e) {
                    e.preventDefault();
                    clearTimeout(hideTimeout);

                    document.querySelectorAll('.tooltip').forEach(t => {
                        if (t !== tooltip) {
                            t.classList.remove('show');
                        }
                    });

                    if (tooltip.classList.contains('show')) {
                        tooltip.classList.remove('show');
                    } else {
                        positionTooltip(tip, tooltip);
                        tooltip.classList.add('show');
                    }
                });

                tooltip.addEventListener('mouseenter', function () {
                    clearTimeout(hideTimeout);
                });

                tooltip.addEventListener('mouseleave', function () {
                    hideTimeout = setTimeout(() => {
                        tooltip.classList.remove('show');
                    }, 200);
                });
            }
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.help-tip') && !e.target.closest('.tooltip')) {
                document.querySelectorAll('.tooltip').forEach(tooltip => {
                    tooltip.classList.remove('show');
                });
            }
        });
    }

    function positionTooltip(trigger, tooltip) {
        const triggerRect = trigger.getBoundingClientRect();
        const tooltipRect = tooltip.getBoundingClientRect();
        const viewportWidth = window.innerWidth;

        let top = triggerRect.bottom + window.scrollY + 10;
        let left = triggerRect.left + window.scrollX;

        if (left + tooltipRect.width > viewportWidth - 20) {
            left = viewportWidth - tooltipRect.width - 20;
        }

        if (left < 20) {
            left = 20;
        }

        tooltip.style.top = `${top}px`;
        tooltip.style.left = `${left}px`;
    }

    function expandAllSections() {
        const headers = document.querySelectorAll('.section-header');

        headers.forEach(header => {
            const targetId = header.getAttribute('data-target');
            const content = document.getElementById(targetId);

            if (content) {
                content.style.display = 'block';
                content.classList.add('active');
                header.classList.add('active');
            }
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            </div>
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }
});